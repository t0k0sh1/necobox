# デザイン文書：ランダム整数ジェネレータ

## 概要

ランダム整数ジェネレータは、Necobox の既存ツール（パスワードジェネレータ、IP表示）と同様のアーキテクチャで実装されます。フロントエンドは React コンポーネント、バックエンドは API ルートで構成されます。

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース                  │
│              (app/random-integer/page.tsx)              │
│  - 入力フォーム（下限、上限、分布、生成数、シード値）        │
│  - 入力値の補正と検証                                     │
│  - 結果表示エリア                                         │
│  - コピーボタン                                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   API エンドポイント                       │
│            (app/api/v1/random-integer/route.ts)         │
│  - リクエスト検証（厳格）                                 │
│  - ランダム値生成ロジック呼び出し                          │
│  - レスポンス返却                                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  ユーティリティ関数                        │
│         (lib/utils/random-integer.ts)                   │
│  - 一様分布による生成                                     │
│  - 正規分布による生成                                     │
│  - シード付き乱数生成                                     │
└─────────────────────────────────────────────────────────┘
```

## コンポーネントとインターフェース

### 1. フロントエンド：ページコンポーネント

**ファイル**: `app/random-integer/page.tsx`

**責務**:
- ユーザー入力の管理（下限、上限、分布、生成数、シード値）
- 入力値の補正と検証（エラー表示を最小化）
- API への POST リクエスト送信
- 生成結果の表示
- コピー機能の実装
- ユーザーフィードバック

**主要な状態**:
```typescript
- min: number (デフォルト: 1)
- max: number (デフォルト: 10000)
- distribution: 'uniform' | 'normal' (デフォルト: 'uniform')
- count: number (デフォルト: 1)
- seed: number (デフォルト: -1)
- results: number[]
- loading: boolean
```

**主要な関数**:
- `handleGenerate()`: 入力値を補正してから API を呼び出す
- `handleCopyValue(value: number)`: 単一の値をコピー
- `handleCopyAll()`: すべての値をコピー
- `normalizeInputs()`: 入力値を補正（大小関係、範囲外の値など）

**入力値の補正ロジック**:
- `min` と `max`: JavaScript の整数範囲内であれば正負両対応。逆転している場合は自動的に入れ替え
- `min` と `max` のテキストボックス: `input="number"` で小数点入力を防止
- 整数範囲外の値: 範囲内に補正
- `count`: 1 以上 100 以下に制限
- `seed`: -1 以下はすべて -1 に補正

### 2. バックエンド：API ルート

**ファイル**: `app/api/v1/random-integer/route.ts`

**責務**:
- POST リクエストの受け取り
- リクエストボディの検証
- ユーティリティ関数の呼び出し
- JSON レスポンスの返却

**リクエストスキーマ**:
```typescript
{
  min: number
  max: number
  distribution: 'uniform' | 'normal'
  count: number
  seed: number
}
```

**レスポンススキーマ**:
```typescript
{
  success: boolean
  data?: {
    results: number[]
    seed: number (実際に使用されたシード値)
  }
  error?: string
}
```

### 3. ユーティリティ関数

**ファイル**: `lib/utils/random-integer.ts`

**関数**:

#### `generateRandomIntegers(options: GeneratorOptions): number[]`
- 指定されたオプションに基づいてランダム整数を生成
- シード値が -1 の場合は現在時刻を使用

#### `generateUniform(min: number, max: number, count: number, seed: number): number[]`
- 一様分布に従うランダム整数を生成
- `crypto.getRandomValues()` を使用した暗号学的に安全な実装
- シード値が指定されている場合は、シード付き乱数生成器を使用

#### `generateNormal(min: number, max: number, count: number, seed: number): number[]`
- 正規分布に従うランダム整数を生成
- Box-Muller 変換を使用して正規分布を生成
- 平均値は (min + max) / 2、標準偏差は (max - min) / 6
- `crypto.getRandomValues()` を使用した暗号学的に安全な実装

#### `seededRandom(seed: number): () => number`
- シード値を使用した再現可能な乱数生成器を返す
- Xorshift アルゴリズムを使用してシード値から乱数を生成

## データモデル

### GeneratorOptions インターフェース
```typescript
interface GeneratorOptions {
  min: number           // 下限値（デフォルト: 1）
  max: number           // 上限値（デフォルト: 10000）
  distribution: 'uniform' | 'normal'  // 確率分布（デフォルト: 'uniform'）
  count: number         // 生成数（デフォルト: 1）
  seed: number          // シード値（デフォルト: -1）
}
```

### ValidationError インターフェース
```typescript
interface ValidationError {
  field: string
  message: string
}
```

## エラーハンドリング

### フロントエンド
- 入力値は自動的に補正されるため、エラー表示を最小化
- `input="number"` で小数点入力を防止
- `count` は 1～100 の範囲に制限
- `seed` は -1 以下を -1 に補正
- API エラーはトースト通知で表示
- ネットワークエラーは適切なメッセージで表示

### バックエンド
- 無効なリクエストボディ: 400 Bad Request
- 検証エラー: 400 Bad Request（詳細なエラーメッセージ付き）
- サーバーエラー: 500 Internal Server Error

### バックエンド検証ルール（厳格）
1. `min` と `max` は整数である必要がある
2. `min` と `max` は JavaScript の整数範囲内である必要がある
3. `count` は 1 以上 100 以下の整数である必要がある
4. `seed` は -1 以上の整数である必要がある
5. `distribution` は 'uniform' または 'normal' である必要がある

## テスト戦略

### ユニットテスト
- **ユーティリティ関数テスト** (`lib/utils/random-integer.test.ts`)
  - 一様分布の生成が指定範囲内であることを確認
  - 正規分布の生成が指定範囲内であることを確認
  - シード値が同じ場合に同じ結果が生成されることを確認
  - 異なるシード値で異なる結果が生成されることを確認

### 統合テスト
- **API エンドポイントテスト** (`app/api/v1/random-integer/route.test.ts`)
  - 有効なリクエストで正しいレスポンスが返されることを確認
  - 無効なリクエストで 400 エラーが返されることを確認
  - シード値が正しく処理されることを確認

### UI テスト
- **コンポーネントテスト** (`components/random-integer-generator.test.tsx`)
  - 入力フォームが正しく機能することを確認
  - コピーボタンがクリップボードに値をコピーすることを確認
  - エラーメッセージが正しく表示されることを確認

## UI/UX デザイン

### レイアウト
- 既存の Necobox デザインに合わせた統一的なレイアウト
- 入力フォーム、結果表示エリア、コピーボタンを配置

### 入力フォーム
- **下限値（Min）**: `input="number"` で整数のみ入力可能、デフォルト 1
- **上限値（Max）**: `input="number"` で整数のみ入力可能、デフォルト 10000
- **確率分布**: ラジオボタン（一様分布 / 正規分布）
- **生成数**: `input="number"` で 1～100 の範囲に制限、デフォルト 1
- **シード値**: `input="number"` で -1 以上の整数を入力可能、デフォルト -1
- **生成ボタン**: プライマリボタン

### 入力値の自動補正
- `min` と `max` が逆転している場合は自動的に入れ替え
- 整数範囲外の値は範囲内に補正
- `count` が 1 未満の場合は 1 に、100 を超える場合は 100 に補正
- `seed` が -1 未満の場合は -1 に補正

### 結果表示
- 生成されたランダム整数をカード形式で表示
- 各値の横にコピーボタンを配置
- 下部に「すべてコピー」ボタンを配置

### フィードバック
- コピー成功時: トースト通知で「コピーしました」と表示
- API エラー時: トースト通知でエラーメッセージを表示
- ローディング中: スピナーを表示

## 実装上の考慮事項

1. **暗号学的に安全な乱数生成**: `crypto.getRandomValues()` を使用
2. **シード値の処理**: -1 の場合は `Date.now()` をシード値として使用
3. **シード付き乱数生成**: Xorshift アルゴリズムで再現可能な乱数を生成
4. **正規分布の実装**: Box-Muller 変換で正規分布を生成し、指定範囲内に収まるようにクリップ
5. **パフォーマンス**: 大量の値生成時も高速に処理できるよう最適化
6. **アクセシビリティ**: Radix UI コンポーネントを使用して WCAG 準拠
7. **ダークモード**: 既存の `next-themes` を使用してダークモード対応
8. **フロントエンド補正**: UI 層で入力値を補正してエラー表示を最小化
9. **バックエンド検証**: API 層で厳格に入力チェックを実施
